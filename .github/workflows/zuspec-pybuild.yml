
name: zuspec_pybuild
on:
  workflow_call:
    inputs:
        version_dir:
            required: true
            type: string
    secrets:
      PYPI_API_TOKEN:
        required: true

jobs:
    linux:
        runs-on: ubuntu-latest
        strategy:
          matrix:
            include:
              - spec: 'cp38-cp38'
              - spec: 'cp39-cp39'
              - spec: 'cp310-cp310'
              - spec: 'cp311-cp311'
              - spec: 'cp312-cp312'
              - spec: 'cp313-cp313'
        steps:
        - name: checkout
          uses: actions/checkout@v4
        - name: Update Version
          shell: bash
          run: |
            tag=$(git tag -l --contains HEAD)

            if test -z ${tag}; then
                # Candidate release
                sed -i \
                  -e 's/VERSION = "\([0-9]\.[0-9]\.[0-9]\)"/VERSION = "\1.${{ github.run_id }}rc0"/g' \
                  ${{ inputs.version_dir }}/__version__.py 
            fi
        
        - name: Build packages
          env:
            IVPM_PYTHON: /opt/python/${{ matrix.spec }}/bin/python
            BUILD_NUM: ${{ github.run_id }}
          run: >
            docker run --rm
            --volume "$(pwd):/io"
            --env IVPM_PYTHON
            --env BUILD_NUM
            --workdir /io
            quay.io/pypa/manylinux2014_x86_64
            /io/scripts/build_linux.sh
        - name: Publish to PyPi
          if: startsWith(github.ref, 'refs/heads/main')
          env:
            BUILD_NUM: ${{ github.run_id }}
            TWINE_USERNAME: __token__
            TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
          run: |
            python3 -m pip install -U twine packaging
            python3 -m twine upload wheelhouse/*.whl


